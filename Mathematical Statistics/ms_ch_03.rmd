---
title: ''
mainfont: Arial
fontsize: 12pt
documentclass: report
header-includes:
- \PassOptionsToPackage{table}{xcolor}
- \usepackage{caption}
- \usepackage{amssymb}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage[table]{xcolor}
- \usepackage{fancyhdr}
- \usepackage{boldline}
- \usepackage{tipa}
   \definecolor{headergrey}{HTML}{545454}
   \definecolor{msdblue}{HTML}{1C93D1}
   \pagestyle{fancy}
   \setlength\headheight{30pt}
   \rhead{\color{headergrey}\today}
   \fancyhead[L]{\color{headergrey}Moretz, Brandon}
   \fancyhead[C]{\Large\bfseries\color{headergrey}Introduction to Hypothesis - Testing Permutation Tests}
   \rfoot{\color{headergrey}Chapter 3}
   \lfoot{\color{headergrey}}
   \fancyfoot[C]{\rmfamily\color{headergrey}Mathematical Statistics}
geometry: left = 1cm, right = 1cm, top = 2cm, bottom = 3cm
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
editor_options: 
  chunk_output_type: console
---


```{r knitr_setup, include = FALSE}

# DO NOT ADD OR REVISE CODE HERE
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, dev = 'png')
options(knitr.table.format = "latex")

```

```{r report_setup, message = FALSE, warning = FALSE, include = FALSE}

library(data.table, quietly = TRUE, warn.conflicts = FALSE)

assignInNamespace("cedta.pkgEvalsUserCode", c(data.table:::cedta.pkgEvalsUserCode, "rtvs"), "data.table")

library(ggplot2, quietly = TRUE, warn.conflicts = FALSE)
library(ggrepel, quietly = TRUE, warn.conflicts = FALSE)
library(ggthemes, quietly = TRUE, warn.conflicts = FALSE)
library(knitr, quietly = TRUE, warn.conflicts = FALSE)
library(kableExtra, quietly = TRUE, warn.conflicts = FALSE)
library(Rblpapi, quietly = TRUE, warn.conflicts = FALSE)
library(scales, quietly = TRUE, warn.conflicts = FALSE)
library(pander, quietly = TRUE, warn.conflicts = FALSE)
library(dplyr, quietly = TRUE, warn.conflicts = FALSE)
library(formattable, quietly = TRUE, warn.conflicts = FALSE)
library(grid, quietly = TRUE, warn.conflicts = FALSE)
library(gridExtra, quietly = TRUE, warn.conflicts = FALSE)
library(png, quietly = TRUE, warn.conflicts = FALSE)
library(extrafont, quietly = TRUE, warn.conflicts = FALSE)
library(tinytex, quietly = TRUE, warn.conflicts = FALSE)
library(stringr, quietly = TRUE, warn.conflicts = FALSE)
library(lubridate, quietly = TRUE, warn.conflicts = FALSE)
library(reshape2, quietly = TRUE, warn.conflicts = FALSE)
library(ggrepel, quietly = TRUE, warn.conflicts = FALSE)
library(mnormt, quietly = TRUE, warn.conflicts = FALSE)
library(Ecdat, quietly = TRUE, warn.conflicts = FALSE)
library(MASS, quietly = TRUE, warn.conflicts = FALSE)
library(copula, quietly = TRUE, warn.conflicts = FALSE)
library(fGarch, quietly = TRUE, warn.conflicts = FALSE)
library(forecast, quietly = TRUE, warn.conflicts = FALSE)
library(tseries, quietly = TRUE, warn.conflicts = FALSE)
library(gmodels, quietly = TRUE, warn.conflicts = FALSE)
library(rugarch, quietly = TRUE, warn.conflicts = FALSE)
library(quantmod, quietly = TRUE, warn.conflicts = FALSE)
library(gtools, quietly = TRUE, warn.conflicts = FALSE)

options(tinytex.verbose = TRUE)
suppressMessages(library("tidyverse"))

pretty_kable <- function(data, title, dig = 2) {
  kable(data, caption = title, digits = dig) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
      kableExtra::kable_styling(latex_options = "hold_position")
}

theme_set(theme_light())

# Theme Overrides
theme_update(axis.text.x = element_text(size = 10),
             axis.text.y = element_text(size = 10),
             plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "darkgreen"),
             axis.title = element_text(face = "bold", size = 12, colour = "steelblue4"),
             plot.subtitle = element_text(face = "bold", size = 8, colour = "darkred"),
             legend.title = element_text(size = 12, color = "darkred", face = "bold"),
             legend.position = "right", legend.title.align=0.5,
             panel.border = element_rect(linetype = "solid", 
                                         colour = "lightgray"), 
             plot.margin = unit(c( 0.1, 0.1, 0.1, 0.1), "inches"))

data.dir <- "D:/Projects/Statistical-Computing/datasets/"

setwd("D:/Projects/Statistical-Computing/RDS")

```

```{r pander_setup, include = FALSE}

knitr::opts_chunk$set(comment = NA)

panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

```

#### Chapter 3 Exercises

### 3.1

Suppose you conduct an experiment and inject a drug into three mice.

Their times for running a maze are 8, 10, 15 s; the times for two control mice are 5 and 9 s.

a.) Compute the difference in mean times between the treatment group and the control group.

```{r, echo = T}

mice.t <- c(8, 10, 15)
mice.c <- c(5, 9)

observed <- mean(mice.t) - mean(mice.c)

observed
```

b.) Write out all the possible permutations of these times to the two groups and calculate the diffence in means.

```{r, echo = T}

mice <- c(mice.t, mice.c)

# 5 choose 3 for treatment

treatment <- combinations(n = 5, r = 3, mice, repeats.allowed = F)

control <- matrix(nrow = 10, ncol = 2)
for( i in 1:nrow(control))
{
  control[i,] <- mice[!mice %in% treatment[i,]]
}

perms <- data.table(cbind(treatment, control))

stopifnot(nrow(perms) == choose(5, 3))

colnames(perms) <- c("D1", "D2", "D3", "C1", "C2")

perms$Xd <- (perms$D1 + perms$D2 + perms$D3) / 3
perms$Xc <- (perms$C1 + perms$C2) / 2
perms$Diff <- round(perms$Xd - perms$Xc, 2)

```

\newpage

```{r, echo = F}
pretty_kable(perms, "Mice Permutations")
```

c.) What proportion of the differences are as large or larger than the observed differences in mean times?

```{r, echo = T}

gte.observed <- perms[Diff >= observed]

pretty_kable(gte.observed, "Greater than or Equal to Observed")

p1c <- nrow(gte.observed) / nrow(perms)

```

__Proportion of differences greater than or equal to observed: `r p1c*100`%__

d.) For each permutation, calculate the mean of the treatment group only.

What proportion of these means are as large or larger than the observed mean of the treatment group?

```{r, echo = T}

gte.t <- perms[ Xd >= mean(mice.t),]
pretty_kable(gte.t, "Mean Treatment Greater than or Equal to Observed")

p1d <- nrow(gte.t) / nrow(perms)

```

__Proportion of treatment groups greater than observed: `r p1d*100`%__

### 3.2

Your statistics professor comes to class with a big urn that she claims contains 9,999 blue marbels and 1 red marble.

You draw our one marble at random and finds that it is red.

Would you be willing to tell your professor that you think she is wrong about the distribution of colors?

Why or why not?

+ Yes, a 1/10,000 chance is pretty rare.

What are you assuming in making your decision?

What if instead, she claims there are nine blue marbles and 1 red one (and you draw out a red marble)?

+ A 1/10 chance is fairly common.

### 3.3

In a hypothesis test comparing two populations means, $H_0 : \mu_1 = \mu_2\ versus \ H_A : \mu_1 > \mu_2$

__a.)__ Which P-value, _0.03_ or _0.006_, provides stronger evidence for the alternative hypothesis?

_0.03_ provides stronger evidence for the alternative hypothesis.

__b.)__ Which P-value, 0.095 or 0.04, provides stronger evidence that chance alone might account for the observed result?

_0.095_ provides stronger evidence that chance alone is responsible for the observed result.

### 3.4

In the algorithms for conducting a permutation test, why do we add 1 to the number of replications N when calculating the P-Value?

__Answer__: We need to account for the original observed result.

### 3.5

In the flight delays case study in Section 1.1, the data contain flight delays for two airlines, American Airlines and United Airlines.

```{r, echo = T}

Flights <- data.table(read.csv(paste0(data.dir, "FlightDelays.csv"),
                               header = T))

```

a.) Conduct a two-sided permutation test to see if the difference in mean delay times between the two carriers are statistically significant.

```{r, echo = T, fig.height=3.5, fig.width=8}

Flights[, .(Delay = mean(Delay)), by = Carrier]

observed <- mean(Flights[Carrier == "UA"]$Delay) - mean(Flights[Carrier == "AA"]$Delay)

N <- 10e2 - 1
results <- numeric(N)

for(i in 1:N)
{
   index <- sample(nrow(Flights), nrow(Flights[Carrier == "UA"]), replace = F)
   results[i] <- mean(Flights[index]$Delay) - mean(Flights[-index]$Delay)
}

p <- (sum(results[results >= observed]) + 1) / ( N + 1)
v <- p*(1 - p) / ( N + 1 )

ggplot(data.table(results)) +
   geom_histogram(aes(results, fill = ..count..)) +
   geom_vline(xintercept = observed, col = "darkorange", linetype = 3, lwd = 1.2) +
   scale_y_continuous(labels = comma) +
   labs(title = paste0("Flight Delay Times, UA/AA vs Observed, p=", p ))


```

b.) The flights took place in May and June of 2009. Conduct a two-sided permutation test to see if the differences in mean delay times between two months is statistically significant.

```{r, echo = T, fig.height=3.5, fig.width=8}

Flights[, .(Delay = mean(Delay)), by = Month]

observed <- mean(Flights[Month == "May"]$Delay) - mean(Flights[Month == "June"]$Delay)

N <- 10e2 - 1
results <- numeric(N)

for(i in 1:N)
{
   index <- sample(nrow(Flights), nrow(Flights[Month == "May"]), replace = F)
   results[i] = mean(Flights[index]$Delay) - mean(Flights[-index]$Delay)
}

p <- (sum(results[results <= observed]) + 1) / ( N + 1)
v <- p*(1 - p) / ( N + 1 )

ggplot(data.table(results)) +
   geom_histogram(aes(results, fill = ..count..)) +
   geom_vline(xintercept = observed, col = "darkorange", linetype = 3, lwd = 1.2) +
   scale_y_continuous(labels = comma) +
   labs(title = paste0("Flight Delay Times, May/June, vs Observed, p=", round(p, 5)))

```